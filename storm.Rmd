---
title: "Tornado hit people, floods hurt economics"
author: "Alex Gaggin"
date: "Friday, August 14, 2015"
output: 
  html_document:
    keep_md: true
---

##Synopsis

U.S. National Oceanic and Atmospheric Administration (NOAA)
tracks and classifies significant weather events in the United States in their
storm database,
assessing, in particular, human and dollar damages. The data
in the dataset was available for years 1950-2011, but for consistency reasons
a shorter time period was analyzed - 1996-2010. The conclusion appears valid for
longer period as well: tornadoes were the threat to human life and health even
before unusually deadly outbreak of 2011.
From economic damages point of view, tornadoes were not as bad
as floods and hurricanes.

## Data Processing

```{r, message=FALSE, warning=FALSE}
# Preload libraries
library(digest)
library(dplyr)
library(lubridate)
library(ggplot2)
```

The data was prepared for download by authors of Reproducible Research course on
the Coursera. It's downloaded and loaded to an R data frame.

```{r, cache=TRUE}
# setwd(file.path(normalizePath("~"),"Coursera-R","RepData_PeerAssessment2"))
# Knitr works in the Rmd file directory, so this isn't needed for it, but
# it can be useful to re-initialize session in console for dev/test/debug

# Download the file - ignore "%2F" imperfection when making a local file name
remote<-"https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
localzip<-basename(remote)
if(!file.exists(localzip)) download.file(remote,localzip)
# No need to unzip - read.csv() does it automatically

# For chunk's console usage - no need to reload data if it's loaded and intact
if(!exists("loaded") || digest(loaded) != "b223723dffbf2ec857526bcc32d2a31d")
   loaded <- read.csv(localzip)
# We keep original data frame for console work caching and make a mutable copy
s<-loaded
```

Beginning dates of the events are converted to the time class and year part
is extracted to a separate variable.

```{r, cache=TRUE}
# Convert beginning dates to date format
s$BGN_DATE<-mdy_hms(s$BGN_DATE)
s$Year<-format(s$BGN_DATE,"%Y")
```

First, let's deal with PROPDMGEXP and CROPDMGEXP fields. The dataset provided
for this exercise doesn't include a code book, so to make sure that we
understand the data properly, and, in particular scale of PROPDMG and CROPDMG
field, let's load the original dataset files from NOAA website, where,
according to section 2.7 of their
[documentation}(https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf),
"Alphabetical characters used to signify magnitude
include "K" for thousands, "M" for millions, and "B" for billions".

```{r, cache=TRUE}
# Let's pick an example event from 2010 and look at it, minus the narrative
# for brevity
somedmg<-tail(s[s$PROPDMG>0 &
                             s$LATITUDE != 0 &
                             s$BGN_DATE<ymd("2011-01-01"),],1)
somedmg %>% select(-REMARKS)

# Let's get unprocessed file with event details for 2010, read it, look at it
url<-"http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d2010_c20140824.csv.gz"
d2010<-basename(url)
if (!file.exists(d2010)) download.file(url,d2010)
bit2010<-read.csv(d2010)
names(bit2010)

# Try to match by latitude, using %in% to ignore NAs
sum(bit2010$BEGIN_LAT %in% somedmg$LATITUDE)

# Nothing? Try by location
sum(bit2010$BEGIN_LOCATION %in% somedmg$BGN_LOCATI)

# There's only one event, let's check it out
origdmg<-bit[bit2010$BEGIN_LOCATION %in% somedmg$BGN_LOCATI,]

origdmg %>% select(-EPISODE_NARRATIVE)

# Seems to be the same event, not sure why coordinates are a bit different -
# was there an update to the database since the copy for the task was made
# by the author of the pre-processed dataset?
```

We see that K in PROPDMGEXP corresponds to K signifier of the damage in the
original files. What other markers do we have and how many of them?
*Obviously, we wouldn't reproduce all the following picking at the data, would
it be a real report, but for purposes of this exercise here it is, in extra
details, as prescribed.*
```{r}
table(s$PROPDMGEXP)
table(s$CROPDMGEXP)
```

We can check them "m" in PROPDMGEXP field is the same as M.

```{r}
somedmg.m<-tail(s[s$PROPDMG>0 &
                             s$LATITUDE != 0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "m",],1)
somedmg.m %>% select(-REMARKS)
# This one is actually from 1994, and its location is empty
url<-"http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1994_c20140824.csv.gz"
d1994<-basename(url)
if (!file.exists(d1994)) download.file(url,d1994)
bit1994<-read.csv(d1994)

# Is there an event with 1M property damage?
table(bit1994$DAMAGE_PROPERTY)
# We have three, let's look at them
bit1994[bit1994$DAMAGE_PROPERTY=="1M",] %>% select(-EVENT_NARRATIVE)
# Here's our tornado in Hinds and Rankin on November 27th at 20:40, it matches
```

The "h" wasn't mentioned in the description, but we assume it's hundreds,
because it's denoted like this in the original files as well.

```{r}
somedmg.H<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "H",],1)
somedmg.H %>% select(-REMARKS)
# Let's get 1995 and look if this event destroyed 500 dollars of property
url<-"http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1995_c20140916.csv.gz"
d1995<-basename(url)
if (!file.exists(d1995)) download.file(url,d1995)
bit1995<-read.csv(d1995)

# Is there an event with 500 property damage?
table(bit1995$DAMAGE_PROPERTY)
# Too many too review, try to match county and date
sum(bit1995$CZ_NAME %in% somedmg.H$COUNTYNAME & 
        bit1995$BEGIN_YEARMONTH == 199507 & bit1995$BEGIN_DAY == 15)
# OK, let's see
bit1995[bit1995$CZ_NAME %in% somedmg.H$COUNTYNAME & 
        bit1995$BEGIN_YEARMONTH == 199507 & bit1995$BEGIN_DAY == 15,] %>%
        select(-EVENT_NARRATIVE)
# Hail that started at Gillette at 18:18 had 5H worth of property damage
# Well, at least original files have this notation principle declared,
# so we assume this means hundreds, which is consistent with dismissive tone
# of the event description
bit1995[10321,]
```

Numeric indicators are less obvious. One potential explanation is that
it means 10^N.

```{r}
somedmg.4<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "4",],1)
somedmg.4 %>% select(-REMARKS)
# We got a flooding in Washington, UT on at 16:25 on March 11th, 1995
sum(bit1995$CZ_NAME %in% somedmg.4$COUNTYNAME & 
        bit1995$BEGIN_YEARMONTH == 199503 & bit1995$BEGIN_DAY == 11)
# Really? Let's drop the county.
sum(bit1995$BEGIN_YEARMONTH == 199503 & bit1995$BEGIN_DAY == 11)
# OK, here it is - the single event of March 11th
bit1995[bit1995$BEGIN_YEARMONTH == 199503 & bit1995$BEGIN_DAY == 11,]
# Huh? Wrong event. Perhaps it was a long flood?
bit1995[bit1995$CZ_NAME %in% somedmg.4$COUNTYNAME & 
         bit1995$BEGIN_YEARMONTH == 199503,]
# Still no floodingin any Washington counties
# Was there any flooding at all that year?
sum(base::grepl("floo",bit1995$EVENT_TYPE, ignore.case=TRUE))
# Four cases, let's review them
bit1995[base::grepl("floo",bit1995$EVENT_TYPE, ignore.case=TRUE),]
# Still no events in Utah
# Let's try match by FIPS numbers
sum(bit1995$CZ_FIPS == somedmg.4$COUNTY &
            bit1995$STATE_FIPS == somedmg.4$STATE__)
# Got three, let's look at them
bit1995[bit1995$CZ_FIPS == somedmg.4$COUNTY &
            bit1995$STATE_FIPS == somedmg.4$STATE__,]
# Wrong ones. Something isn't right here.


# Well, let's try some other event.
somedmg.5<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "5",],1)
somedmg.5
# We are looking for a flash flood in Rockbridge county, VA, on June 22nd.
sum(bit1995$CZ_NAME %in% somedmg.5$COUNTYNAME & 
        bit1995$BEGIN_YEARMONTH == 199506 & bit1995$BEGIN_DAY == 22)
# Still nothing, perhaps there's a mispelled name, try FIPS
sum(bit1995$CZ_FIPS == somedmg.5$COUNTY &
            bit1995$STATE_FIPS == somedmg.5$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199506 &
            bit1995$BEGIN_DAY == 22)
# Nothing, let's try another case
somedmg.6<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "6",],1)
somedmg.6
# Thunderstorm in Marion country, IL on May 18th, 1995
sum(bit1995$CZ_FIPS == somedmg.6$COUNTY &
            bit1995$STATE_FIPS == somedmg.6$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199505 &
            bit1995$BEGIN_DAY == 18)
# Three, let's review
bit1995[bit1995$CZ_FIPS == somedmg.6$COUNTY &
            bit1995$STATE_FIPS == somedmg.6$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199505 &
            bit1995$BEGIN_DAY == 18,]
# Here it is
bit1995[18635,]
# So 15 and 6 was actually 156. Did the person who did processing just took
# last symbol as scale indication? But case for millions in the previous
# example didn't match.
# Another try.
somedmg.7<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "7",],1)
somedmg.7
# Flash flood in Northampton country, NC on July 4th.
sum(bit1995$CZ_FIPS == somedmg.7$COUNTY &
            bit1995$STATE_FIPS == somedmg.7$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199507 &
            bit1995$BEGIN_DAY == 04)
# Single entry
bit1995[bit1995$CZ_FIPS == somedmg.7$COUNTY &
            bit1995$STATE_FIPS == somedmg.7$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199507 &
            bit1995$BEGIN_DAY == 04,]
# 15 minutes difference, no property damage in the original

# Let's check smaller scale.
somedmg.2<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "2",],1)
somedmg.2
# Thunderstorm in Callaway country, MO on June 8th. Still 1995.
sum(bit1995$CZ_FIPS == somedmg.2$COUNTY &
            bit1995$STATE_FIPS == somedmg.2$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199506 &
            bit1995$BEGIN_DAY == 08)
# Two events
bit1995[bit1995$CZ_FIPS == somedmg.2$COUNTY &
            bit1995$STATE_FIPS == somedmg.2$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199506 &
            bit1995$BEGIN_DAY == 08,]
# The one at 4:59 did 122 dollars of damage to a mobile home. Again,
# the last digit was split to EXP field. Not much for "heavily damaged".
# Perhaps the original file is actually wrong?
```

It's not 10^n. It appears that numbers in PROPDMGEXP field is a processing
error and they should be glued to PROPDMG. What about "-", "?", "+" there?

```{r}
somedmg.minus<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "-",],1)
somedmg.minus
# High wind in Oregon on December 12th. Still 1995.
# County is zero.
sum(bit1995$STATE_FIPS == somedmg.minus$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199512 &
            bit1995$BEGIN_DAY == 12)
# No events in Oregon on December 12th.
sum(bit1995$STATE_FIPS == somedmg.minus$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199512)
# Nothing in all December.
sum(bit1995$STATE_FIPS == somedmg.minus$STATE__)
# 39 events in Oregon. Does one lack county?
bit1995[bit1995$STATE_FIPS == somedmg.minus$STATE__,]$CZ_FIPS
# No luck. Well, there's just a single minus, let's just ignore it.

somedmg.plus<-tail(s[s$PROPDMG>0 &
                             s$BGN_DATE<ymd("2011-01-01") &
                             s$PROPDMGEXP == "+",],1)
somedmg.plus
# Tornado in multiple counties in NV, June 5th, 1995.
sum(bit1995$STATE_FIPS == somedmg.plus$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199506)
# Two events.
bit1995[bit1995$STATE_FIPS == somedmg.plus$STATE__ &
            bit1995$BEGIN_YEARMONTH == 199506,]
# Here it is
bit1995[10449,]
# Just 60 for described damage doesn't seem right, but it's what in both
# files, and plus doesn't match anything.
```

There's was no clear logic in additional symbols, so we'll apply following
strategy:
* H for hundred, K for thousand, M for million, B for billion;
* digits should be glued to base number;
* other symbols discarded, assuming their smaller share won't affect results
in a significant way.

```{r}
unexp<-function(d,exp){
        if(exp %in% c("h","H"))
                r<-as.numeric(d)*100
        else if (exp %in% c("k","K"))
                r<-as.numeric(d)*1000
        else if (exp %in% c("m","M"))
                r<-as.numeric(d)*1000000
        else if (exp %in% c("b","B"))
                r<-as.numeric(d)*1000000000
        else if (exp %in% 0:9)
                r<-as.numeric(paste0(d,exp))
        else r<-d
        r}

s$EconomicDamage<-mapply(unexp,s$PROPDMG,s$PROPDMGEXP)+
        mapply(unexp,s$CROPDMG,s$CROPDMGEXP)
```

For the harm done to humans, let's count affected persons, killed or injured.

```{r, cache=TRUE}
s$Affected<-s$FATALITIES+s$INJURIES

```

Event type names seem to duplicate, let's aggregate them.

```{r}
# After checking unique(s$EVTYPE)
s$type<-tolower(s$EVTYPE)
aggr<-function(df,pattern,to)
        df %>% mutate(type=ifelse(grepl(pattern,type,fixed=FALSE),to,type))
s<-aggr(s,"tstm","thunderstorm")
s<-aggr(s,"thunderstorm","thunderstorm")

s<-aggr(s,"wind","wind")
s<-aggr(s,"wnd","wind")

s<-aggr(s,"slide","debris flow")
s<-aggr(s,"lands","debris flow")

s<-aggr(s,"nado","tornado")
s<-aggr(s,"ndao","tornado")

s<-aggr(s,"flash fl","flash")

s<-aggr(s,"flood","flood")
s<-aggr(s,"fld","flood")
s<-aggr(s,"high water","flood")

s<-aggr(s,"hail","hail")

s<-aggr(s,"hail","hail")

s<-aggr(s,"spout","spouts")

s<-aggr(s,"cold","cold")
s<-aggr(s,"frost","cold")
s<-aggr(s,"freez","cold")
s<-aggr(s,"low t","cold")
s<-aggr(s,"hypoth","cold")

s<-aggr(s,"snow","snow")

s<-aggr(s,"lightn","lightning")

s<-aggr(s,"blizz","blizzard")

s<-aggr(s,"rain","rain")
s<-aggr(s,"shower","rain")
s<-aggr(s,"prec","rain")
s<-aggr(s,"wet","rain")

s<-aggr(s,"warm","heat")
s<-aggr(s,"heat","heat")
s<-aggr(s,"hot","heat")
s<-aggr(s,"record high","heat")

s<-aggr(s,"dry","drought")
s<-aggr(s,"drie","drought")
s<-aggr(s,"droug","drought")

s<-aggr(s,"tide","tide")
s<-aggr(s,"surf","tide")
s<-aggr(s,"wave","tide")
s<-aggr(s,"coastal surge","tide")
s<-aggr(s,"high seas","tide")

s<-aggr(s,"volcan","volcano")

s<-aggr(s,"ice","ice")
s<-aggr(s,"icy","ice")

s<-aggr(s,"winter","winter")
s<-aggr(s,"wintry","winter")

s<-aggr(s,"fire","fires")

s<-aggr(s,"swell","swells")

s<-aggr(s,"hurr","hurricane")
s<-aggr(s,"typh","hurricane")
s<-aggr(s,"tropical","hurricane")

s<-aggr(s,"dust","dust")

s<-aggr(s,"temper","temperature")

s<-aggr(s,"flash","flash flood")
```

The NOAA Storm Events Database
[webpage](https://www.ncdc.noaa.gov/stormevents/details.jsp) explains that
before 1955 the only event type registered was tornado, and then until 1996
three types of events were recorded - tornado, thunderstorm wind and hail.
Thus the comparison for event types should start in 1996.

```{r,cache=TRUE}
recent<-s[s$BGN_DATE>ymd("1996-01-01"),]
```

What are top 10 event types that caused most life loss and injuries?

```{r}
deadly10<-tapply(recent$Affected,recent$type,sum) %>%
        sort(decr=TRUE) %>%
        head(10) %>%
        data.frame
names(deadly10)<-'Affected'
deadly10$Event<-rownames(deadly10)
# Order it to prevent gplot from re-sorting bar alphabetically
deadly10$Event<-factor(deadly10$Event, levels=rev(deadly10$Event))
print(deadly10, row.names=FALSE)
```


What are top event types that caused most economic damage?

```{r}
costly10<-tapply(recent$EconomicDamage,recent$type,sum) %>%
        sort(decr=TRUE) %>%
        head(10) %>%
        data.frame
names(costly10)<-'EconomicDamage'
costly10$Event<-rownames(costly10)
costly10$Event<-factor(costly10$Event, levels=rev(costly10$Event))
print(costly10, row.names=FALSE)
```


Aggregate health damage cost by tornado annually.

```{r}
Tornado<-recent[recent$type=="tornado",]
Annual.tornado.health.damage<-with(Tornado, tapply(Affected,Year,sum))
# Compendate for the missing month in 2011
Annual.tornado.health.damage["2011"]<-
        round(Annual.tornado.health.damage["2011"]*12/11)
Annual.tornado.health.damage
```

There's an outlier in 2011 (a quick google search shows there was indeed
a deadliest tornado outbreak in April 2011), let's see damages
in 1996 - 2010 instead to set the outbreak aside.

```{r,cache=TRUE}
framed<-recent[recent$BGN_DATE<ymd("2011-01-01"),]

deadly10<-tapply(framed$Affected,framed$type,sum) %>%
        sort(decr=TRUE) %>%
        head(10) %>%
        data.frame
names(deadly10)<-'Affected'
deadly10$Event<-rownames(deadly10)
# Order it to prevent gplot from re-sorting bar alphabetically
deadly10$Event<-factor(deadly10$Event, levels=rev(deadly10$Event))
print(deadly10, row.names=FALSE)

costly10<-tapply(framed$EconomicDamage,framed$type,sum) %>%
        sort(decr=TRUE) %>%
        head(10) %>%
        data.frame
names(costly10)<-'EconomicDamage'
costly10$Event<-rownames(costly10)
costly10$Event<-factor(costly10$Event, levels=rev(costly10$Event))
print(costly10, row.names=FALSE)
```

It looks like we can operate 1996-2010 year range to draw general conclusions,
as dropping 2011 doesn't change the event type comparison picture. Before
1996 the data was focused on tornadoes with thunderstorms added later, so
we shouldn't expect any possible changes to our conclusions from that data.

## Results

Tornadoes, supposedly as a result of their rapid nature, are the biggest
cause of human life loss and injuries. They are far ahead even without
significant outbreak in 2011.

```{r}
redplot<-ggplot(data=deadly10,
          aes(x=Event,y=Affected)
          )+
        geom_bar(stat='identity',fill='red')+
        coord_flip()+
        ggtitle("Top 10 types of weather events that caused\n biggest loss of human life and health in 1996-2010")+
        ylab("Number of people killed or injured")+
        xlab("Event type")
print(redplot)
```


Damage to property and agriculture is more significant from floods and
hurricanes.

```{r}
# Scale damages to thousands to billions
greenplot<-ggplot(data=costly10,
          aes(x=Event,y=EconomicDamage/1000000000)
          )+
        geom_bar(stat='identity',fill='darkgreen')+
        coord_flip()+
        ggtitle("Top 10 types of weather events that caused\n most damage to property and crops in 1996-2010")+
        ylab("Economic damage, $US billion")+
        xlab("Event type")
print(greenplot)

```

<!--
## To do
- Check and handle NAs
- Do a geo check
- Should I treat outliers? Do they and regular events need different policies?
-->